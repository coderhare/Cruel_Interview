## 一、写在前面

关于哈希槽

> 链接：https://www.cnblogs.com/frankcui/p/15355089.html

关于redis的哈希槽

## 二、Redis哈希槽

### 1、哈希槽

Redis Cluster在设计中没有使用一致性哈希（Consistency Hashing），而是使用数据分片引入哈希槽（hash slot）来实现；

一个 Redis Cluster包含16384（0~16383）个哈希槽，存储在Redis Cluster中的所有键都会被映射到这些slot中，集群中的**每个键都属于这16384个哈希槽中的一个**。按照槽来进行分片，通过为每个节点指派不同数量的槽，可以控制不同节点负责的数据量和请求数.

> [为什么redis集群的最大槽数是16384个？](https://www.cnblogs.com/frankcui/p/15354682.html)
>
> 在redis节点发送心跳包时需要把所有的槽放到这个心跳包里，以便让节点知道当前集群信息，16384=16k，在发送心跳包时使用`char`进行bitmap压缩后是2k（`2 * 8 (8 bit) * 1024(1k) = 16K`），也就是说使用2k的空间创建了16k的槽数。
>
> 虽然使用CRC16算法最多可以分配65535（2^16-1）个槽位，65535=65k，压缩后就是8k（`8 * 8 (8 bit) * 1024(1k) =65K`），也就是说需要需要8k的心跳包，作者认为这样做不太值得；并且一般情况下一个redis集群不会有超过1000个master节点，所以16k的槽位是个比较合适的选择。

假设当前集群有3个节点,槽默认是平均分的:

- 节点 A （6381）包含 0 到 5499号哈希槽.
- 节点 B （6382）包含5500 到 10999 号哈希槽.
- 节点 C （6383）包含11000 到 16383号哈希槽.

![img](https://img2020.cnblogs.com/blog/1552449/202109/1552449-20210930011640764-603796536.png)

### 2、哈希槽计算公式

集群使用公式slot=CRC16（key）/16384来计算key属于哪个槽，其中CRC16(key)语句用于计算key的CRC16 校验和。

### 3、哈希槽怎么工作

我们看到的是master节点在 Redis Cluster中的实现时，都存有所有的路由信息。
当客户端的key 经过hash运算，发送slot 槽位不在本节点的时候：

- （1）如果是非集群方式连接，则直接报告错误给client，告诉它应该访问集群中那个IP的master主机。
- （2）如果是集群方式连接，则将客户端重定向到正确的节点上。

注意这里并不是127.0.0.1:7001 帮client去连接127.0.0.1:7003获取数据的，而是将客户端请求重定向了。

![img](https://img2020.cnblogs.com/blog/1552449/202109/1552449-20210929224233141-203980382.png)



### 4、哈希槽的优点

很容易添加或者删除节点：

- 比如如果我想新添加个节点D, 我需要从节点 A, B, C中转移部分槽到D上即可.
- 如果我像移除节点A,需要将A中得槽移到B和C节点上,然后将没有任何槽的A节点从集群中移除即可.

由于从一个节点将哈希槽移动到另一个节点并不会停止服务,所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态.
