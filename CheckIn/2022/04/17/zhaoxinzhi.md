## 一、写在前面

数据库的视图与临时表。



关于死锁，有空进一步整理链接里的例子：

https://www.cnblogs.com/netlock/p/13177357.html



## 二、数据库



### 1、视图

视图是按照你的sql语句生成的一个虚拟的东西，本身并不占数据库的空间

创建视图 `create view view_1 as select id from table_1`

当你表里的数据增加或者删除的时候，你视图里的内容也随之变化

总之你不能对视图进行update或者insert into操作

说白了，就是视图的变化随着表的变化而变化

除非重新create or replace view_1才能把这个视图中的东西改掉

应用场景：有一个查询语句非常复杂，大概有100行这么多，有时还想把这个巨大无比的select语句和其他表关联起来得到结果，写太多很麻烦，可以用一个视图来代替这100行的select语句，充当一个变量角色

> 视图的作用:
>
> https://blog.csdn.net/qq_27093831/article/details/116897309



### 2、临时表

临时表只在当前连接可见，当关闭连接时，Mysql会自动删除表并释放所有空间。意思就是临时表就储存在内存中，临时创建的表，你把sql语句跑完，关掉，它就没了。所以，我们经常只是在存储过程或者频繁操作语句的时候能用到临时表。

对于临时表有如下几个特点：

- 本地临时表就是用户在创建表的时候添加了“#”前缀的表，其特点是根据数据库连接独立。只有创建本地临时表的数据库连接有表的访问权限，其它连接不能访问该表；
- 不同的数据库连接中，创建的本地临时表虽然“名字”相同，但是这些表之间相互并不存在任何关系；在SQLSERVER中，通过特别的命名机制保证本地临时表在数据库连接上的独立性。
- 真正的临时表利用了数据库临时表空间，由数据库系统自动进行维护，因此节省了表空间。并且由于临时表空间一般利用虚拟内存，大大减少了硬盘的I/O次数，因此也提高了系统效率。
- 临时表在事务完毕或会话完毕数据自动清空，不必记得用完后删除数据。

应用场景：在写存储过程时，有很多的连接，比如你需要连接A,B,C,D,E,F,G,H那么多张表，才能得到你的结果表，同时做连接的消耗太大，你可以先A,B,C连接的结果，放在临时表，接着再把这张临时表，跟D,E,F连接，作为新的结果放在临时表，接着再把临时表与G,H连接，最后得到临时表数据，一次插入到结果表（永久表）

查询数据并写入临时表：`select * into #tab from table;`

删除临时表：`drop table #tab;`

**本地临时表**

```
CREATE TABLE #Temp
(
    id int,
    customer_name nvarchar(50),
    age int
)
```

本地临时表的名称以单个数字符号 (#) 打头；它们仅对当前的用户连接（也就是创建本地临时表的connection）是可见的；当用户从 SQL Server 实例断开连接时被删除。

**全局临时表**

全局临时表的名称以两个数字符号 (##) 打头，创建后对任何数据库连接都是可见的，当所有引用该表的数据库连接从 SQL Server 断开时被删除。

```
CREATE TABLE ##Temp
(
    id int,
    customer_name nvarchar(50),
    age int
)
INSERT INTO ##Temp VALUES(1,'老王',20),(2,'老张',30),(3,'老李',25)
```

### 3、视图和表的区别

1、视图是已经编译好的sql语句，而表不是 
2、视图没有实际的物理记录，而表有
3、表是内容，视图是窗口
4、表只用物理空间而视图不占用物理空间，视图只是逻辑概念的存在，表可以及时对它进行修改，但视图只能有创建的语句来修改（即不能update，insert into具体表的数据）
5、表是内模式，视图是外模式
6、视图是查看数据表的一种方法，可以查询数据表中某些字段构成的数据，只是一些SQL语句的集合。从安全的角度说，视图可以不给用户接触数据表，从而不知道表结构。
7、表属于全局模式中的表，是实表；视图属于局部模式的表，是虚表。
8、视图的建立和删除只影响视图本身，不影响对应的基本表。

9、视图占用较小，只保存sql逻辑，而表保存实际的数据

10、视图一般用于查询。

联系：
视图（view）是在基本表之上建立的表，它的结构（即所定义的列）和内容（即所有数据行）都来自基本表，它依据基本表存在而存在。一个视图可以对应一个基本表，也可以对应多个基本表。视图是基本表的抽象和在逻辑意义上建立的新关系。



### 4、with as

> 参考链接：https://blog.csdn.net/qq_47219637/article/details/111941158

with as 相当于虚拟视图。

其实就是把一大堆重复用到的sql语句放在with as里面，取一个别名，后面的查询就可以用它，这样对于大批量的sql语句起到一个优化的作用，而且清楚明了。

特别对于union all比较有用。因为union all的每个部分可能相同，但是如果每个部分都去执行一遍的话，则成本太高，所以可以使用with as短语，则只要执行一遍即可。如果with as短语所定义的表名被调用两次以上，则优化器会自动将with as短语所获取的数据放入一个temp表里，如果只是被调用一次，则不会。而提示materialize则是强制将with as短语里的数据放入一个全局临时表里。很多查询通过这种方法都可以提高速度。



WITH语句的优点:

(1). SQL可读性增强。比如对于特定with子查询取个有意义的名字等。

(2)、with子查询只执行一次，将结果存储在用户临时表空间中，可以引用多次，增强性能。

举例:在进行导入EXCEL的过程中，有时候，需要将数据存储在临时表中，当下一次在进行导入的时候，进行清除临时表的数据，但是这时候，有时候发生并发问题的话，两个用户可能会分别操作对方的数据，所以，可能造成混乱，但是可以使用WITH函数和UNION语句拼接一个SQL语句，存储在SESSION中，当需要导出错误信息的时候，可以使用该语句构造数据。
