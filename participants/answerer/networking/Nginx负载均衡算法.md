# 负载均衡算法
> 参考来源： https://zhuanlan.zhihu.com/p/68733507
> https://juejin.cn/post/6844903793012768781

### 负载均衡
从负载均衡设备的角度来看，分为硬件负载均衡和软件负载均衡：

- 硬件负载均衡：比如最常见的F5，还有Array等，这些负载均衡是商业的负载均衡器，性能比较好，毕竟他们的就是为了负载均衡而生的，背后也有非常成熟的团队，可以提供各种解决方案，但是价格比较昂贵，所以没有充足的理由，充足的软妹币是不会考虑的。
- 软件负载均衡：包括我们耳熟能详的Nginx，LVS，Tengine（阿里对Nginx进行的改造）等。优点就是成本比较低，但是也需要有比较专业的团队去维护，要自己去踩坑，去DIY。

从负载均衡的技术来看，分为服务端负载均衡和客户端负载均衡：

- 服务端负载均衡：当我们访问一个服务，请求会先到另外一台服务器，然后这台服务器会把请求分发到提供这个服务的服务器，当然如果只有一台服务器，那好说，直接把请求给那一台服务器就可以了，但是如果有多台服务器呢？这时候，就会根据一定的算法选择一台服务器。
- 客户端负载均衡：客户端服务均衡的概念貌似是有了服务治理才产生的，简单的来说，就是在一台服务器上维护着所有服务的ip，名称等信息，当我们在代码中访问一个服务，是通过一个组件访问的，这个组件会从那台服务器上取到所有提供这个服务的服务器的信息，然后通过一定的算法，选择一台服务器进行请求。


### 常见的几种负载均衡算法
**1. 轮询法**
> 有些资料里头整理还有一种平滑加权轮询，它的权重是动态调整的

按顺序均衡地分配请求给后台服务器。
   
**2. 随机法**

随机分配请求。
   
**3.源地址哈希法**

根据客户端的IP地址，通过哈希函数计算得到的一个数值，用该数值对
服务器列表的大小进行取模运算，得到的结果便是客户端要访问的服务器的序号。
存在一个问题，当IP相同，后端服务器列表不变时，每次都会映射到同一台后端服务器进行访问。

**4. 加权轮询法**

不同的后端服务器可能机器的配置与当前系统的负载并不相同，因此它们的抗压能力也不同。
给配置高，负载低的机器配置更高的权重，让其处理更多的请求；而配置低，负载高的机器，让其分配给比较低的权重，降低系统负载。

**5. 加权随机法**
加权随机法根据后端机器的配置，系统的负载分配不同的权重。不同的是，它是按照权重随机请求后端服务器。

**6.最小连接数法**
根据后端服务器当前的连接情况，动态地选取其中当前积压连接数最小的一台服务器来处理
当前的请求。

### Nginx的5种负载均衡算法
1. 轮询（默认）

2. weight
指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况
   
如
```c++
upstream bakend {  
  server 192.168.0.14 weight=10;  
  server 192.168.0.15 weight=10;  
}
```   
3、ip_hash

每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。

例如：
```c++
upstream bakend {
    ip_hash;
    server 192.168.0.14:88;
    server 192.168.0.15:80;
}
```
4、fair（第三方）

按后端服务器的响应时间来分配请求，响应时间短的优先分配。

```c++
upstream backend {  
    server server1;  
    server server2;  
    fair;  
}
```
5、url_hash（第三方）

按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。

例：在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法。
```c++
upstream backend {  
    server squid1:3128;  
    server squid2:3128;  
    hash $request_uri;  
    hash_method crc32;  
}
```
tips:
```c++
upstream bakend{#定义负载均衡设备的Ip及设备状态  
    ip_hash;  
    server 127.0.0.1:9090 down;  
    server 127.0.0.1:8080 weight=2;  
    server 127.0.0.1:6060;  
    server 127.0.0.1:7070 backup;  
}
```
在需要使用负载均衡的server中增加

proxy_pass http://bakend/;
每个设备的状态设置为：

1. down 表示单前的server暂时不参与负载
2. weight 默认为1.weight越大，负载的权重就越大。
3. max_fails ：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误
4. fail_timeout:max_fails次失败后，暂停的时间。
5. backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。

nginx支持同时设置多组的负载均衡，用来给不用的server来使用。

`client_body_in_file_only`：设置为On，可以讲client post过来的数据记录到文件中用来做debug。

`client_body_temp_path`：设置记录文件的目录，可以设置最多3层目录。

`location`：对URL进行匹配，可以进行重定向或者进行新的代理，负载均衡。
