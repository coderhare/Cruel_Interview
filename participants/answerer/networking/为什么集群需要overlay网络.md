## 为什么集群需要 Overlay 网络
> 参考链接：https://draveness.me/whys-the-design-overlay-network/

Overlay是指延展网络（Overlay Network），Overlay 网络其实并不是一门新技术，
它是指构建在另一个网络上的计算机网络1，这是一种网络虚拟化技术的形式，
近年来云计算虚拟化技术的演进促进了网络虚拟化技术的应用。
![](https://img.draveness.me/2020-05-14-15893911326242-overlay-network.png)

因为 Overlay 网络是建立在另一个计算机网络之上的虚拟网络，所以它不能独立出现，Overlay 底层依赖的网络就是 Underlay 网络，这两个概念也经常成对出现。

Underlay 网络是专门用来承载用户 IP 流量的基础架构层，
它与 Overlay 网络之间的关系有点类似物理机和虚拟机。Underlay 
网络和物理机都是真正存在的实体，它们分别对应着真实存在的网络设备和计算设备，
而 Overlay 网络和虚拟机都是依托在下层实体使用软件虚拟出来的层级。
![](https://img.draveness.me/2020-05-14-15893911326270-network-and-compute.png)

在分析 Overlay 网络的作用之前，我们需要对它的常见实现有大概的了解，
在实践中我们一般会使用虚拟局域网扩展技术（Virtual Extensible LAN，VxLAN）组建 Overlay 网络。
在下图中，两个物理机可以通过三层的 IP 网络互相访问：
![](https://img.draveness.me/2020-05-14-15893911326285-overlay-network-packet.png)
上图中两个 VTEP 会相互连接并获得网络中的 MAC 地址、IP 地址等信息，例如，服务器 1 中的 VTEP 需要知道想要访问绿色网络中的 10.0.0.2 
虚拟机需要先访问 IP 地址为 204.79.197.200 的服务器 2。这些配置可以被网络管理员手动配置、
自动学习、也可以通过上层的管理器设置。当绿色的 10.0.0.1 虚拟机想要向绿色的 10.0.0.2 
![](https://img.draveness.me/2020-05-14-15893911326285-overlay-network-packet.png)
发送数据时，会经过以下几个步骤：
1. 绿色的 10.0.0.1 会将 IP 数据包发送给 VTEP；
2. 服务器 1 的 VTEP 收到 10.0.0.1 发送的数据包后；
3. 从收到的 IP 数据包中获取目的虚拟机的 MAC 地址；
4. 在本地的转发表中查找该 MAC 地址所在服务器的 IP 地址，即 204.79.197.200；
5. 将绿色虚拟机所在的虚拟网络标识符（VxLAN Network Identifier、VNI）以及原始的 IP 数据包作为负载，构建新的 UDP 数据包；
6. 将新的 UDP 数据包发送到网络中；
7. 服务器 2 的 VTEP 收到 UDP 数据包后；
8. 去掉 UDP 数据包中的协议头；
9. 查看数据包中 VNI；
10. 将 IP 数据包转发给目标的绿色服务器 10.0.0.2；
11. 绿色的 10.0.0.2 会收到绿色服务器 10.0.0.1 发送的数据包；

Overlay 网络解决的三个问题：

1. 云计算中集群内的、跨集群的或者数据中心间的虚拟机和实例的迁移比较常见；
2. 单个集群中的虚拟机规模可能非常大，大量的 MAC 地址和 ARP 请求会为网络设备带来巨大的压力；
3. 传统的网络隔离技术 VLAN 只能建立 4096 个虚拟网络，公有云以及大规模的虚拟化集群需要更多的虚拟网络才能满足网络隔离的需求；

