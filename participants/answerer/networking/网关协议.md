## 网关协议
> 网络层控制平面

网关实际上是一个网络通往其他网络的IP地址。

内部网关协议



### ISP间的路由选择协议

**BGP协议**

* BGP会话：2个路由器在一个半永久的TCP连接上交换BGP报文
*


AS内部的路由器通告信息，无所隐瞒

AS间的路由器选择讲究策略

AS间的路径选择可能讲究策略，比方说可能不根据单纯的链路开销，还根据流量的来源，这是由自定义的函数确定的

￼

#### 层次性路由

BGP协议的工作原理：
参与内部网关的计算，获得内部子网的可达信息，通过eBGP通告，通告的IP作为该子网的下一跳，再通过iBGP告诉内部的路由器，包括网关…迭代下去



#### 对比
内部网关协议关注性能，外部网关协议关注策略。
打个比方，AS的考量会取决于利益，政治因素，以及安全性等等，因此外部网关协议关注策略。

#### BGP协议的属性：
- AS-PATH：包含通告已经通过的AS列表
- NEXT-HOP：AS-PATH起始的路由器接口的IP地址

#### IP任播
除了作为互联网的AS间路由协议外，BGP还常被用于实现IP任播服务。
IP任播被DNS系统广泛用于将DNS请求指向最近的根服务器

#### IP任播的动机：
- 在分散的不同物理位置，替换不同服务器上的相同内容
- 让每个用户从最近服务器访问内容

#### BGP配置错误事件
BGP配置对于互联网流量路由至关重要，配置错误，经过BGP的自动扩散，会导致互联网流量紊乱甚至中断。

- AS 7007事件
- 2018年11月14日，尼日尼亚互联网服务商MainOne由于配置错误，将直连Google的网络路由泄漏到中国电信的网络，然后通过中国电信的BGP传播到其他ISP中，导致一部分北美连接Google服务的流量通过迂回的AS路径传输。11月13日，MainOne承认出现错误。
- 2019年6月6日，甲骨文的一名安全分析师发现瑞士数据中心托管商Safe Host的AS泄露了7万个路由记录到中国电信的网络，并通过中国电信的BGP传播，导致部分欧洲的互联网流量绕进了中国电信的网络，这个配置错误至少延续了2个小时。该安全分析师也抱怨中国电信没有对其接收的BGP路由信息进行验证而照单转发，导致错误不能在几分钟内修复。
- 2021年Facebook死机事件：2021年10月4日，由于配置错误，Facebook的DNS权威服务器地址通过BGP撤销，导致用户和Facebook的其他服务的服务器无法根据DNS获得相应的服务器地址，导致Facebook的网络服务中断了6~7小时。
- 另外，故意的配置错误也可以用于劫持特定AS的网络用于实现某些目的，例如防火长城用于审查或拦截特定不接受内容审查的内容供应商的网络。