# MySQL面试题（二）



### 短连接风暴

- 先处理掉那些占着连接但是不工作的线程。

max_connections 的计算，不是看谁在 running，是只要连着就占用一个计数位置。对于

那些不需要保持的连接，我们可以通过 kill connection 主动踢掉。这个行为跟事先设置

wait_timeout 的效果是一样的。设置 wait_timeout 参数表示的是，一个线程空闲

wait_timeout 这么多秒之后，就会被 MySQL 直接断开连接。



- 减少连接过程的消耗。

有的业务代码会在短时间内先大量申请数据库连接做备用，如果现在数据库确认是被连接行

为打挂了，那么一种可能的做法，是让数据库跳过权限验证阶段。

跳过权限验证的方法是：重启数据库，并使用–skip-grant-tables 参数启动。这样，整个

MySQL 会跳过所有的权限验证阶段，包括连接过程和语句执行过程在内。

但是，这种方法特别符合我们标题里说的“饮鸩止渴”，风险极高，是我特别不建议使用的

方案。尤其你的库外网可访问的话，就更不能这么做了。

在 MySQL 8.0 版本里，如果你启用–skip-grant-tables 参数，MySQL 会默认把 --skip

networking 参数打开，表示这时候数据库只能被本地的客户端连接。可见，MySQL 官方

对 skip-grant-tables 这个参数的安全问题也很重视。



### 慢查询问题

- 导致慢查询的第一种可能是，索引没有设计好。

这种场景一般就是通过紧急创建索引来解决。MySQL 5.6 版本以后，创建索引都支持

Online DDL 了，对于那种高峰期数据库已经被这个语句打挂了的情况，最高效的做法就是

直接执行 alter table 语句。

比较理想的是能够在备库先执行。假设你现在的服务是一主一备，主库 A、备库 B，这个方

案的大致流程是这样的：

1. 在备库 B 上执行 set sql_log_bin=off，也就是不写 binlog，然后执行 alter table 语句

加上索引；

2. 执行主备切换；

3. 这时候主库是 B，备库是 A。在 A 上执行 set sql_log_bin=off，然后执行 alter table

语句加上索引。

- 第二种可能是语句没写好

- 第三种可能是MySQL选错了索引



### QPS 突增问题

有时候由于业务突然出现高峰，或者应用程序 bug，导致某个语句的 QPS 突然暴涨，也可

能导致 MySQL 压力过大，影响服务。

而下掉一个功能，如果从数据库端处理的话，对应于不同的背景，有不同的方法可用。

1. 一种是由全新业务的 bug 导致的。假设你的 DB 运维是比较规范的，也就是说白名单是

一个个加的。这种情况下，如果你能够确定业务方会下掉这个功能，只是时间上没那么

快，那么就可以从数据库端直接把白名单去掉。

2. 如果这个新功能使用的是单独的数据库用户，可以用管理员账号把这个用户删掉，然后

断开现有连接。这样，这个新功能的连接不成功，由它引发的 QPS 就会变成 0。

3. 如果这个新增的功能跟主体功能是部署在一起的，那么我们只能通过处理语句来限制。

这时，我们可以使用上面提到的查询重写功能，把压力最大的 SQL 语句直接重写

成"select 1"返回。

当然，这个操作的风险很高，需要你特别细致。它可能存在两个副作用：

1. 如果别的功能里面也用到了这个 SQL 语句模板，会有误伤；

2. 很多业务并不是靠这一个语句就能完成逻辑的，所以如果单独把这一个语句以 select 1

的结果返回的话，可能会导致后面的业务逻辑一起失败。

所以，方案 3 是用于止血的，跟前面提到的去掉权限验证一样，应该是你所有选项里优先

级最低的一个方案。

其实方案 1 和 2 都要依赖于规范的运维体系：虚拟化、白名单机制、业务

账号分离。由此可见，更多的准备，往往意味着更稳定的系统。
