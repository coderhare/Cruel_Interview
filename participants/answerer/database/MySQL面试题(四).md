# MySQL面试题：高可用

> 选自MySQL45讲

### 主备延迟

主备切换可能是一个主动运维动作，比如软件升级，主库所在机器按计划下线等，也可能是被动操作，比如主库所在机器掉电。

「同步延迟」，与数据同步有关的时间点主要有三个：

1. 主库A执行完成一个事务，写入binlog，这个时刻记为T1

2. 之后传给备库B，我们把备库B接收完这个binlog的时刻记为T2

3. 备库B执行完成这个事务，这个时刻记为T3

所谓的主备延迟，就是同一个事务，在备库执行完成的时间与主库执行完成的时间之间的差值，也就是T3 - T1。

在备库上可以执行`show slave status`来显示`seconds_behind_master`，这个结果实际上是`T3-T1`。

**如果主备库机器的系统时间设置不一致，会不会导致主备延迟的值不准？**

- 不会。因为备库连接到主库时，会通过执行`SELECT UNIX_TIMESTAMP`函数来获取当前主库的系统时间。如果这时候发现主库的系统时间与自己的不一致，备库在执行`seconds_behind_master`计算时会自动扣掉这个差值

网络正常情况下，主备延迟的主要来源是备库接收完 binlog和执行完这个事务之间的时间差。所以说，主备延迟最直接的表现是，备库消费中转日志（relay log）的速度，比主库生产binlog 的速度要慢。



### 主备延迟的来源

1. **有些部署条件下，备库所在机器的性能比主库所在机器性能差**

2. **备库压力大：（解决方案**
   
   - 一主多从。除了备库外，可以多接几个从库，让这些从库分担读的压力
   
   - 通过binlog输出到外部系统，比如Hadoop这类系统，让外部系统提供统计类查询的能力

3. **大事务**
   
   - 其中一种场景是对于一些归档类的数据，平时没有注意删除历史数据，等到空间快满了，业务人员要一次性删除大量历史数据。同时，又因为要避免在高峰期操作会影响业务，所以会在晚上执行涉及大量数据的删除操作
   
   - 大表DDL->处理方案是对于计划内的DDL，使用gh-ost方案。

4. 备库的并行复制能力


